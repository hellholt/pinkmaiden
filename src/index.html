<!DOCTYPE html>
<html lang="en">

<head>
  <script>
    class ImageLoader {
      constructor() {
        this.checkpoint = Math.floor((new Date()).getTime() / 1000);
        this.isLocked = false;
        this.isDisabled = false;
      }

      async loadImages() {
        if (this.isLocked || this.isDisabled) {
          return;
        }
        this.isLocked = true;
        let fetchUrl = `/api/images?checkpoint=${this.checkpoint}&count=50`;
        try {
          let response = await fetch(fetchUrl);
          let jsonResponse = await response.json();
          this.checkResponse(jsonResponse.images);
          this.displayImages(jsonResponse.images);
          this.updateCheckpoint(jsonResponse.images);
        } catch (error) {
          console.log(`That's all, folks!`);
        } finally {
          this.isLocked = false;
        }
      }

      checkResponse(images) {
        if (!images || !images.length) {
          this.isDisabled = true;
        }
      }

      displayImages(images) {
        let imageContainer = document.getElementById('image_container');
        images.forEach(image => {
          let imageElement = document.createElement('img');
          imageElement.src = image.thumbnail_url;
          let linkElement = document.createElement('a');
          linkElement.href = image.image_url;
          linkElement.target = '_blank';
          linkElement.appendChild(imageElement);
          imageContainer.appendChild(linkElement);
        });
      }

      updateCheckpoint(images) {
        try {
          let checkpoint = parseInt(images.slice(-1)[0].stamp);
          this.checkpoint = Math.max(this.checkpoint, checkpoint) + 1;
        } catch (error) {
          console.error(error);
          throw error;
        }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const imageLoader = new ImageLoader();
      imageLoader.loadImages();
      window.onscroll = () => {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight) {
          imageLoader.loadImages();
        }
      };
    });
  </script>

</head>

<body>
  <h1><a href="https://github.com/ndouglas/pinkmaiden/">Pinkmaiden</a></h1>
  <div id="image_container"></div>
</body>

</html>